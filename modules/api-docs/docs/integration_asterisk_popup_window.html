<h1>
    Интеграция OneBox и Asterisk: всплывающее окошко
</h1>

<p>
    Когда поступает входящий звонок в сервер телефонии, OneBox способен показывать нужному сотруднику (менеджеру)
    всплывающее окошко с информацией кто ему звонит.
    <br/>
    Это окошко мы часто называем call window.
</p>
<br/>

<p>
    Технический механизм для каждой системы телефонии может быть разный.
    <br/>
    Эта статья описывает как правильно интегрировать Asterisk (и производные от него системы типа FreeBPX, Elastix, …) с
    OneBox, чтобы OneBox показывал такое окошко.
</p>
<br/>

<h2>
    Инструкция
</h2>

<p>
    Сначала нужно сделать все, что описано в инструкции «Интеграция OneBox и телефонии - оригинация звонков»
    <a href="/doc/integration_originate_calls">
        (ссылка)
    </a>
    и убедиться, что она работает.
    <br/>
    Затем, тестово один раз с параметром force запустить php -f modules/box/cron/cron-ami.php force.
    <br/>
    Если соединение удалось, то вы получите на выходе что-то типа такого:
</p>
<br/>

<code>
    <pre>
[518] =>
[519] => 991051175
[520] => 0993101312
[521] =></pre>
</code>
<br/>

<p>
    Это будет большой массив, который показывает кто кому сейчас звонит или кто с кем сейчас разговаривает.
</p>
<br/>

<p>
    Структура массива такая: [to] => [from]
    <br/>
    То есть, запись [520] => 0993101312 означает, что номер 0993101312 звонит/позвонил/разговаривает с внутренним
    номером 520.
</p>
<br/>

<p>
    Технический offtopic: по сути этот массив запрашивается каждую минуту, он сохраняется в таблицу shopuservoip, на
    основе которой OneBox способен понять кто кому звонит.
</p>
<br/>

<p>
    В массиве который вам показал php -f modules/box/cron/cron-ami.php force вам нужно посмотреть в каком формате
    записаны внешние номера. В нашем случае внешний номер записан как 991051175 и как 0993101312. Это сокращенные
    форматы номеров, правильный полный формат такой: 380 991051175, 38 0993101312
    В engine.mode.php прописываем простой обработчик формата номера, задача которого всего одна: привести формат номера
    к правильному. Пример такого обработчика:
</p>
<br/>

<code>
    <pre>
// трансляция номеров:
// приведение номеров к правильному формату
class BoxNumberProcessor_Megalink {

    public function process($phone) {
// это внутренний номер
        if (strlen($phone) <= 4) {
            return $phone;
        }

        if (strlen($phone) == strlen('989688430')) {
            $phone = '380'.$phone;
        }

        if (strlen($phone) == strlen('0964860297')) {
            $phone = '38'.$phone;
        }

        return $phone;
    }

}</pre>
</code>
<br/>

<p>
    и записываем его в конфиг-параметр:
</p>
<br/>

<code>
    <pre>
// обработчик номеров
Engine::Get()->setConfigField('project-box-event-parser-call-processor', 'BoxNumberProcessor_Megalink’);</pre>
</code>
<br/>

<p>
    Повторно запускаем php -f modules/box/cron/cron-ami.php force и убеждаемся, что номера в правильном формате.
</p>
<br/>

<code>
    <pre>
[518] =>
[519] => 380991051175
[520] => 380993101312
[521] =></pre>
</code>
<br/>

<p>
    Добавляем запуск cron-ami.php в cron каждую минуту.
    <br/>
    Добавляем в engine.mode.php строку, которая отвечает за показ всплывающего окошка:
</p>
<br/>

<code>
    <pre>
// включить окошко входящего звонка по AMI
Engine::Get()->setConfigField('project-box-call-window', true);</pre>
</code>
<br/>

<p>
    Заходим в OneBox, прописываем себе правильный внутренний номер (например 520) и звоним на него, убеждаемся что
    всплывающее окошко появляется.
</p>
<br/>

<h2>
    Частные случаи и проблемы
</h2>

<ul>
    <li>
        Если cron-ami.php force ничего такого не показывает и пишет ошибку соеденения - обратитесь к системному
        администратору сервера телефонии. Возможно вас забанили или AMI пароль не верный.
    </li>
    <li>
        Если cron-ami.php force подключается, но выдает какой-то левый массив и там на номера ничего не похоже -
        скопируйте
        всю выдачу cron-ami.php и отправьте ее администратору сервера телефонии, пусть разберется почему там нет
        нормальных
        номеров.
    </li>
    <li>
        Если у вас уже в кроне висит скрипт cron-ami.php и вы что-то меняете в конфигах, скрипте обработки номеров и
        т.д.,
        то вам нужно сделать kill старого php скрипта. Потому что cron-ami.php запускается один раз и висит бесконечно
        долго, пока его кто-то не kill или он сам не упадет из-за программной ошибки.
    </li>
</ul>