<h1>
    Интеграция OneBox с IMAP
</h1>

<p>
    OneBox умеет читать письма через IMAP как-будто обычный почтовый клиент.
    <br/>
    Раз в минуту OneBox подключается по очереди к почтовым ящикам, авторизируется, и вычитывает список писем, которые
    есть в каждой папке почтового ящика, записывает эти данные в события (ShopEvent type=email).
</p>
<br/>

<p>
    Эта статья описывает ряд особенностей и частых вопросов по интеграции с почтой.
</p>
<br/>

<h2>Как настроить интеграцию?</h2>
<p>
    В engine.mode.php по примеру box/example.engine.mode.php пропишите имена почтовых ящиков и настройки их поключения.
    <br/>
    В cron добавьте box/cron/cron-imap.php раз в 5 минут.
</p>
<br/>

<p>
    Пример подключения в engine.mode.php:
</p>

<br/>
<code>
    <pre>
$a = array();

$a[] = array(
'host' => 'host',
'username' => 'login',
'password' => 'password',
// port => '143',
// name => 'email', // если не задать, используется username
);

$a[] = array(
'host' => 'host',
'username' => 'login',
'password' => 'password',
// port => '143',
// name => 'email', // если не задать, используется username
);

Engine::Get()->setConfigField('project-box-event-parser-imap', $a);
    </pre>
</code>
<br/>

<p>
    Значения параметров:<br/>
    host - адрес для подключения. Тут может быть IP или адрес mx-сервера.<br/>
    username - как правило полный адрес email<br/>
    password - пароль<br/>
    port - если не задать, будет использоваться 143<br/>
    name - полное имя почтового ящика, если оно отличается от username.
</p>
<br/>

<h2>Можно ли cron-imap.php ставить чаще чем раз в 5 минут?</h2>
<p>
    Только если почта сторонняя типа mail.ru, ukr.net, gmail.com или почта размещена на отдельном сервере. В структуре
    amazino можно.<br/>
    Почему так? Вычитывание почтовых ящиков создает нагрузку на дисковую систему.
</p>
<br/>

<h2>Какая нормальная скорость вычитывания почты?</h2>
<p>
    В среднем это 1 почтовый ящик - 5-10 секунд. То есть, очень быстро.
    Это происходит потому, что OneBox получает сначала список UID писем, а потом проверяет было ли у него такое письмо
    ранее или нет.
</p>
<br/>

<h2>Что делать если почта перестала читаться или стала читаться медленно?</h2>
    Скорее всего дело в одном из:<br/>
<ul>
    <li>в каком-то почтовом ящике был изменен пароль, и попытки подключиться к нему затягиваю время. Это можно проверить
    просто запустив cron-imap.php с параметром force. Если там будут ошибки подключения - вы их увидите.<br/>
    </li>
    <li>скорее всего почтовый ящик был полностью почищен админскими средствами (админ удалил файлы на сервере для быстрой
    очистки) или почтовый ящик был пененесен на другой сервер. В таком случае сбиваются все UID. Чтобы все восстановить
    - просто очистите таблицу imapeventuid в базе данных, и OneBox начнет вычитывать письма с самого начала. Первый раз
    это может быть долго. Или запустите box/tools/tool-imap-reload.php - что в принципе тоже самое.
    </li>
</ul>