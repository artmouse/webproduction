<h1>
    Инструкция по переносу сайта с сервера на сервер
</h1>
<br/>
<br/>

<p>
    Перенос сайта чем-то похож определенными действиями на выгрузку нового проекта. Если Вы с этим сталкивались -
    проблем возникнуть не должно. Ниже будет приведена поочередность действий, необходимых для переноса сайта с сервера
    на сервер (по примеру переноса на сервера Amazino)
</p>
<br/>

<p>
    1. Перенаправление доменного имени
    <br/>
    По умолчанию мы переносим сайты на сервера amazino. Поэтому домен по умолчанию необходимо направить на NS-сервера:
    <br/>
    ns1.amazino.com
    <br/>
    ns2.amazino.com
</p>
<br/>

<p>
    2. Привязка доменного имени
    <br/>
    В панели управления хостингом ISPConfig (находится по адресу https://ns1.amazino.com:8080/) Вам необходимо:
</p>

<ul>
    <li>
        добавить клиента, при этом выбран шаблон хостинга во вкладке Limits (определяет выделяемые ресурсы на
        аккаунт), а так же выбрать сервера по умолчанию для сайта и базы данных
    </li>
    <li>
        во вкладке DNS добавляем доменную зону (доменное имя), привязывая её к IP сервера (по умолчанию выгрузка
        происходит на ws3.amazino.com | 77.120.101.144, если в задаче не указан конкретный сервер).
    </li>
</ul>

<p>
    3. Добавление сайта / базы данных / ssh-доступа
    <br/>
    Данные действия отлично описаны в соответствующих пунктах документации по выгрузке сайта на сервера Amazino
    https://box.webproduction.ua/doc/onebox_deploy_amazino в пункте "Создание аккаунта".
</p>
<br/>

<p>
    4. Перенос сайта с сервера на сервер
    <br/>
    Самый простой и быстрый вариант переноса - путём архивирования с сервера на сервер. Данный способ позволяет 2
    действия (архивирование/перенос) сократить в 1 - архивирование сразу на удаленный сервер.
</p>
<br/>

<p>
    Ваши действия:
    <br/>
    4.1 В директории сайта снимаем дамп базы данных - для этого используется команда:
</p>

<code><pre>
mysqldump -u databaseuser -p databasepasswd database &gt; mysqldumpname.sql
</pre>
</code>

<p>
    где:
    <br/>
    -u databaseuser - пользовать БД
    <br/>
    -p databasepasswd - пароль к БД
    <br/>
    database - название БД
    <br/>
    mysqldumpname.sql - название файла дампа БД
</p>
<br/>

<p>
    4.2 Архивирование и перенос сайта на другой сервер
    <br/>
    Для создания архива сайта и дампа БД используется команда:
</p>

<code><pre>
tar -czvf file.tgz [path]
</pre>
</code>

<p>
    К примеру, если Вы находитесь в директории сайта webproduction.ua, то команда будет выглядеть:
</p>
<code><pre>
tar -czvf webproduction.ua.tgz . (точка в конце означает "архивировать содержимое текущей директории)
</pre>
</code>

<p>
    Дальнейший шаг - это перенос архива по FTP/SSH протоколу на другой сервер.
    <br/>
    НО важно в нашем деле упростить задачу - и поэтому к Вашему вниманию шаблон команды для одновременного
    архивирования:
</p>

<code><pre>
tar -czvf - . | ssh user@host 'dd of=[path/to/file.tgz]'
</pre>
</code>

<p>
    где, указанно [ создать архив - содержимого текущей директории | подключившись по ssh 'в такую-то директорию/в
    такой-то архив' ] примером команды может быть:
</p>

<code><pre>
tar -czvf - . | ssh c61_wpsite_ua@77.120.101.14 'dd of=../../web/webproduction.ua.tgz'
</pre>
</code>

<p>
    По выполнению команды она попросит Вас ввести пароль аналогично стандартному подключению по ssh.
    После Вам нужно зайти на сервер назначения и распаковать архив командой tar -xzvf file.tgz
</p>
<br/>

<p>
    4.3 Заливка дампа базы данных
    <br/>
    После того, как Вы перенесли архив с сайтом и дампом БД и разархивировали данный архив - Вам необходимо залить дамп
    БД в созданную БД на новом сервере. Для этого используеться команда:
</p>
<code><pre>
mysql -u databaseuser -p databasepasswd database &lt; mysqldump.sql
</pre>
</code>
<br/>

<p>
    4.4 Настройка engine.mode.php
    <br/>
    В связи с переносом у нас меняются данные конфигурации, в связи с чем необходимо подправить engine.mode.php, а
    именно:
</p>
<ul>
    <li>прописать доменное имя (если оно изменилось)</li>
    <li>прописать доступы к новой базе данных</li>
</ul>

<p>
    4.5 Перенос custom php.ini settings
    <br/>
    ВАЖНО! при переносе ОБЯЗАТЕЛЬНО проверьте содержание файла php.ini.
    К примеру, на серверах типа webproduction4.com.ua он находится в директории /var/php-bin/php.ini в аккаунте
    перемещаемого сайта.
    <br/>
    Если же в нём присутствуют кастомные настройки типа max_input_vars=100000 и т.д. - их обязательно необходимо
    перенести в ISPConfig во вкладку Options конкретного сайта (каждый в новой строке) в соответствующее поле.
    Это нужно для ПОЛНОЙ РАБОТОСПОСОБНОСТИ сайта после переноса (загрузки прайсов и т.д.)
</p>
<br/>

<p>
    4.6 Установка crontab
    <br/>
    В связи с переносом на новый сервер необходимо так же прописать кроны в планировщик задач.
    Кроны прописываются в IPSConfig во вкладке Cron Jobs в формате /usr/bin/php -d memory_limit=500M -f
    ~/web/cron/cron-minute.php &gt;/dev/null 2&gt;&amp;1
    <br/>
    ВАЖНО! Если Вы переносите новый движок, и у него в корне проекта есть файлы формата cron.minute.conf /
    cron.hour.conf / cron.day.conf - данные кроны в панели прописывать не нужно - они отрабатывают движком в плановом
    режиме.
</p>
<br/>

<p>
    4.7 Перенастройка Sphinx Search
    <br/>
    Если на переносимом Вами сайте использовался поисковый движок Sphinx-Search - то Вам необходимо дополнительно:
</p>
<ul>
    <li>
        изменить подключение к БД и путь к sphinx (/var/lib/sphinx/data/) в конфигурационном файле sphinx.conf
    </li>
    <li>
        перезапуск и принудительная индексация Sphinx Search Engine на сервере (с помощью root-доступа администратора)
    </li>
</ul>

<p>
    5. Перенос почты
    <br/>
    Если на предыдущем сервере у клиента использовалась почта, то вам необходимо:
</p>

<ul>
    <li>
        создать аналогичные почтовые ящики на новом сервере
    </li>
    <li>
        с помощью локальной утилиты imapcopy организовать перенос почты с одного сервера на другой. В конфиге данной
        утилиты всё элементарно понятно - указывается исходный сервер, сервер назначения, а так же в конце файла доступы
        к почтовым ящикам (на обеих серверах) - из какого ящика в какой копировать почту.
    </li>
</ul>