<h1>Что такое KPI и как их разрабатывать?</h1>

KPI - это ключевый показатель эффективности.<br />
С технической точки зрения это просто маленький класс, который выполняет какой-то подсчет и возвращает полученное число.<br />
OneBox считает по каждому сотруднику записывает это число в таблицу XShopKPIUser каждый час.
То есть, любой показатель KPI пересчитывается и записывается каждый час, вместе с историей.<br />
<br />

<h2>Как технически работает KPI</h2>

Изначально есть таблица XShopKPI.
Это просто таблица-список, в которую занесено имя показателя, класс который за него отвечает,
и необязательный параметр, который может передаваться в этот класс.<br />
<br />

Например, вот KPI, который считает количество выполненных задач пользователем с начала месяца:<br />
<br />

<code><pre>
class BoxKPI_IssueDoneMonth {

    public function process(User $user, $workflowID = false) {
        $cdate = date('Y-m-01').' 00:00:00';

        $issues = IssueService::Get()->getIssuesAll();
        $issues->setManagerid($user->getId());
        $issues->addWhere('dateclosed', $cdate, '>=');
        if ($workflowID) {
            $issues->setCategoryid($workflowID);
        }
        return $issues->getCount();
    }

}
</pre></code>
<br />

Есть всего один метод process(), в которым первым параметром всегда передается $user, для которого мы считаем KPI,
а вторым параметром передается “необязательный параметр shopkpi.param”.<br />
Метод process всегда должен вернуть число. Это может быть int, float, decimal, но число.<br />
<br />

<h2>Как пользователь настраивает свои KPI</h2>

<ul>
    <li>заходим в настройку ролей</li>
    <li>на каждую роль выбираем какие KPI нужно считать (выбираем KPI и параметр, если нужно. Этот параметр будет передаваться вторым параметром в метод process)</li>
    <li>Дополнительно можно указать зарплатный бизнес-процесс и коеффиент зарплаты. Работает просто: после подсчета KPI он умножится на коэффициент и запишется в зарплатный заказ.</li>
    <li>Дополнительно можно указать плановый показатель. Это просто число, по которому будет построен второй график (фактически желаемый) в отчетах.</li>
    <li>внутри карточки пользователя в поле Должность нам нужно выбрать нужную должность, так система поймет у какого юзера какая должность, а у должности какие KPI. Можно указать несколько должностей.</li>
    <li>по cron-hour система берет всех сотрудников, по ним берет их должности, по ним берет их KPI, считает каждый KPI и записывает данные в таблицу KPI.</li>
    <li>Затем KPI пользователя можно смотреть в карточке контакта (TAB KPI) и в отчете Сравнение KPI план-факт.</li>
</ul>

<h2>Как писать KPI?</h2>
Очень часто клиент просит сделать какие-то KPI под него. Это могут быть самые безумные извращения.
Программируются эти KPI очень просто:

<ul>
    <li>нужно написать новые классы ProjectName_KPI_xxxx</li>
    <li>добавить этот класс в реестр KPI через метод addKPI()</li>
</ul>

<code><pre>
if (PackageLoader::Get()->getMode('development')) {
    // call
    KPIService::Get()->addKPI('BoxKPI_CallDay', 'Количество звонков за день');
    KPIService::Get()->addKPI('BoxKPI_CallDay', 'Количество входящих звонков за день', 1);
    KPIService::Get()->addKPI('BoxKPI_CallDay', 'Количество исходящих звонков за день', -1);
}
</pre></code>
<br />

<strong>Важное замечание: коммитить эти KPI нужно:</strong><br />

<ul>
<li>в проект клиента (в модуль projectname/trunk/api/)</li>
<li>В редких случаях сразу в модуль box/trunk/api/. Это можно делать только в тех случаях, когда вы программируете KPI, которые явно универсальные и могут быть добавлены в наш OneBox для всех клиентов.</li>
</ul>

<strong>Не забудьте прописать в синхронизаторе модуля</strong> добавление этого KPI. Есть даже специальный метод KPIService::Get()->addKPI().<br />
Так как метод <strong>addKPI() делает изменения и проверки в базе, то заворачивайте его в mode development</strong>.<br />
Как в примере выше.<br />