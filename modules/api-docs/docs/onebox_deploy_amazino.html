<h1>
    Как выгружать OneBox на Amazino
</h1>

<p>
    Ниже описаны шаги по выгрузке проекта с возможными вариантами. При выгрузке стоит следовать строгой очередности во
    избежание лишних ошибок и "что-то забыли подключить".
</p>
<br/>

<p>
    По умолчанию все проекты выгружаются на сервера amazino.com.
    <br/>
    Их на данный момент 3:
</p>
<ul>
    <li>
        ws1.amazino.com (77.120.101.20)
    </li>
    <li>
        ws2.amazino.com (77.120.101.14)
    </li>
    <li>
        ws3.amazino.com (77.120.101.144)
    </li>
</ul>

<p>
    Для работы из-под аккаунта клиента первоначально сервер уже определен.
</p>
<br/>

<h2>
    Создание аккаунта
</h2>

<p>
    Для того, чтобы создать аккаунт Вам необходимо (действия описаны из-под администратора):
</p>
<ul>
    <li>
        Зайти в панель ISPConfig для управления сервером/хостингом по адресу https://ns1.amazino.com:8080/
    </li>
    <li>
        Добавить клиента во вкладке Clients, где указать обязательные поля + во вкладке Limits - шаблон (по умолчанию
        HDD1).
        <br/>
        P.S.: Если у Вас имеется доступ Клиента — делаете дальнейшие действия.
    </li>
    <li>
        Если используется боевой домен - необходимо добавить DNS-зону для домена, где IP=ip сервера сайта.
    </li>
    <li>
        Добавить сайт во вкладке Sites, где при добавлении указать: server (ws2.amazino.com выбираем по умолчанию),
        client (выбрать из списка), domain (указать доменное имя, по которому будет доступен сайт), Harddisk Quota (по
        умолчанию = лимиту клиента, если размещается 1 сайт).
        <br/>
        P.S.: при добавлении сайта из-под аккаунта клиента — сервер и клиент не доступен к выбору, так как уже
        определен.
    </li>
    <li>
        Создать пользователя Базы Данных во вкладке Sites >> Database users
    </li>
    <li>
        Создать Базу Данных во вкладке Sites >> Databases - обязательно выбрать тот же сервер, который выбран для
        сайта (для быстрой работы), выбрать сайт, юзера БД, указать название базы и кодировку UTF-8.
        <br/>
        P.S.: если Вы работает из-под доступа клиента — Вам уже определен сервер для выгрузки при создании клиента во
        вкладке Limits.
    </li>
    <li>
        Создать доступ SSH к сайту во вкладке Sites >> Shell-User
    </li>
</ul>

<h2>
    Выгрузка проекта
</h2>

<ol>
    <li>
        Заходим на сервер с помощью консоли Shell с помощью команды ssh user@domain, при этом подтвердив подключение
        паролем (который получили при создании shell-user`а в панели управления хостингом)
    </li>
    <li>
        Переходим в рабочую директорию домена путем cd /var/www/domain/web (или же cd ../../web)
    </li>
    <li>
        Удаляем файлы index.html, htaccess, robots.txt (оставляем только системные папки stats и error)
    </li>
    <li>
        Выгружаем движок командой svn co https://svn.webproduction.ua/wpshop/wpshop/trunk . (заметьте, что точка в
        конце не просто так - это означает выгрузить содержимое репозитория в текущую директорию)
    </li>
    <li>
        Выгружаем необходимые модуля в папку /modules/ движка. Перечень базовых модулей:
        <br/>
        contact, order, document, finance, storage, box, seo, seotags, product-margin, product-supplierprice,
        search-sphinx
        <br/>
        Если необходимо выгрузить OneBox - ко всем вышеперечисленным модулям выгрузить модуль box.
        <br/>
        Дополнительные модуля - binotel, novaposhta, intime, rest-api, utm-label и т.д.
        <br/>
        Пример команды выгрузки - svn co https://svn.webproduction.ua/wpshop/wpshop/modules/contact/trunk
        modules/contact (из какого репозитория в какую директорию. директорию создаст автоматически)
        <br/>
        P.S.: пункты 4 и 5 более подробно описаны в разделе документации Как правильно выгрузить «OneBox со всеми
        модулями» или по этой
        <a href="/doc/how_to_unload_onebox">
            ссылке
        </a>
        .
    </li>
</ol>

<h2>
    Настройка проекта
</h2>

<ol>
    <li>
        Создание файла engine.mode.php - делаем с помощью команды копирования файла на сервере через консоль в
        директории движка (проекта) - cp example.engine.mode.php engine.mode.php (что - куда копировать).
        <br/>
        Заходим в редактирование файла - nano engine.mode.php
        <br/>
        Необходимо:
        <ul>
            <li>
                раскомментировать строку и указать доменное имя (хост)
                <code>
                    <pre>Engine::Get()->setConfigField('project-host', 'domain')</pre>
                </code>
            </li>
            <li>
                раскомментировать блок и указать данные для подключения к БД (пользователя, пароль и название БД)
            </li>
            <li>
                подключить модуля - раскомментировать и прописать необходимые модуля в строке
                <code>
                    <pre>Engine::Get()->setConfigField('shop-module', array('quiz'));</pre>
                </code>
                в формате
                <code>
                    <pre>Engine::Get()->setConfigField('shop-module', array('quiz', 'contact', 'order', 'document'));</pre>
                </code>
                и т.д. все необходимые модуля.
                <br/>
            </li>
            <li>
                остальные настройки - по ненадобности закомментировать (они подписаны).
            </li>
        </ul>
    </li>
    <li>
        Установка расписания крон-скриптов.
        <br/>
        По умолчанию необходимо прописать 3 крона - cron-minute.php , cron-hour.php и cron-day.php
        <br/>
        Дополнительно может появится необходимость прописать другие кроны:
        <br/>
        cron-ami.php - для телефонии
        <br/>
        cron-imap.php - парсер почты
        <br/>
        tool-import-imageurl.php - тулза для загрузки изображений по ссылкам при импорте Ексель (находится в
        /web/tools/tool-import-imageurl.php)
        <br/>
        Кроны прописываются в ISPConfig`е во вкладке Sites >> Cron jobs по формату: /usr/bin/php -d memory_limit=500M -f
        ~/web/cron/cron-minute.php >/dev/null 2>&1 (обязательно выберите сайт, на котором исполнять крон и правильное
        время выполнения)
    </li>
    <li>
        Запуск проекта.
        <br/>
        В файле engine.mode.php раскомментировать строки:
        <code>
            <pre>PackageLoader::Get()->setMode('development');
Engine::Get()->enableErrorReporting();</pre>
        </code>
        после чего запустить команду ./updater.sh , и повторить пока не отработает без ошибок и не заработает сайт.
        После вышеуказанные строки закоментировать.
    </li>
</ol>


<h2>
    Настройка поисковой системы Sphinx
</h2>

<p>
    Поисковая система работает в 2х режимах - plain и rt.
    <br/>
    По умолчанию рекомендуется использовать режим plain.
</p>
<ol>
    <li>
        Необходимо выгрузить модуль search-sphinx/trunk
    </li>
    <li>
        Скопировать содержимое конфига из файла /modules/search-sphinx/example.engine.mode.php в файл engine.mode.php в
        корне движка (сам конфиг)
    </li>
    <li>
        Прописать названия индексов по формату domain_index (к примеру yazz_product) и указать режим работы (по
        умолчанию plain)
    </li>
    <li>
        Скопировать содержимое из файла /modules/search-sphinx/example-plain.sphinx.conf в файл sphinx.conf (с помощью
        редактора nano), прописать соответствующие названия индексов и пути.
    </li>
    <li>
        Пересобрать и переиндексировать сфинкс на сервере командами:
        <br/>
        systemctl stop searchd - остановка поисковой системы на сервере
        <br/>
        в директории cd /etc/sphinx/ запускаем команду ./sphinx.sh - пересобираем сфинкс
        <br/>
        indexer --all - переиндексация индексов
        <br/>
        systemctl start searchd - запуск сфинкса
    </li>
</ol>

<p>
    Важно! Остановка, переиндексация и запуск сфинкса выполняются на сервере из под root (обращайтесь к Тындыку
    Максиму).
    <br/>
    Пример настройки сфинкса в режиме real-time описан в разделе «Инструкция по подключению и работе со Sphinx» или по
    этой
    <a href="/doc/search-sphinx-main">
        ссылке
    </a>
    .
</p>
<br/>