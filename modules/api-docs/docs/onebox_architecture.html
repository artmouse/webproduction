<h2>Общая архитектура системы OneBox</h2>

OneBox - достаточно сложный технический продукт, в котором около 200М исходных кодов.<br />
<br />
Если не учитывать сотни вспомогательных сервисов и инструкций по пакетам (packages),
то можно выделить такие основные подсистемы.<br />
В будущем количество сервисов и модулей может дополняться.<br />
<br />

<h2>Из чего состоит OneBox?</h2>

<ul>
    <li>Из модулей (module) и сервисов (service).<br /></li>
    <li>В каждом модуле и основном проекте есть директория /api/services/<br /></li>
    <li>В ней храняться классы-сервисы.<br /></li>
    <li>Каждый класс-сервис имеет определенную структуру -
см. <a href="/doc/services_override">устройство сервисов и переопределение сервисов</a>.<br /></li>
    <li>Каждый класс-сервис управляет сущносями (системные классы, X-классы).<br /></li>
</ul>
<br />

<h2>Основные (базовые) сервисы OneBox</h2>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
    <thead>
        <tr>
            <td>Сервис</td>
            <td>Основной класс сервиса</td>
            <td>Системные классы (сущности)</td>
            <td>Описание</td>
            <td>Доступность</td>
        </tr>
    </thead>

    <tr valign="top">
        <td><strong>Контакты и пользователи</strong></td>
        <td>UserService</td>
        <td>User</td>
        <td>Любые действия связанные с клиентами, контактами, сотрудниками, компаниями - это все контакты. Это все User-ы. Все связано с пользователями.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Продукты - товары и услуги</strong></td>
        <td>ProductService</td>
        <td>ShopProduct, ShopBrand, ShopCategory</td>
        <td>
            В терминах OneBox - справочник товаров и услуг - это продукты, таблица shopproduct
            и сущность ShopProduct. У продуктов есть ссылка на категорию (ShopCategory) и бренд (ShopBrand), а также еще огромная куча дополнительных настроек и полей. Продукты тесно связаны с заказами/задачами/проектами (Order) и складами (Storage).<br />
            Основные характеристики Продуктов, с которыми чаще всего прийдется иметь дело, это:<br />
            <ul>
                <li>название продукта</li>
                <li>цена продажи (просто цена, поле price)</li>
                <li>валюта (currencyid)</li>
                <li>входящая цена (закупочная цена, поле pricebase)</li>
                <li>категория (categoryid)</li>
                <li>бренд (currencyid)</li>
                <li>скрытый ли товар (hidden)</li>
                <li>удаленный ли товар (deleted)</li>
                <li>есть ли товар в наличии (avail)</li>
                <li>поставщик по умолчанию для этого товара (supplierid)
                - это поле проставляет модуль пересчета цен.</li>
            </ul>
        </td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Заказы</strong> и производные от них Проекты, Задачи и тд (Order)</td>
        <td>OrderService</td>
        <td>ShopOrder, ShopOrderProduct, ShopOrderEmployer, ShopOrderContact</td>
        <td>Все сущности хранятся в таблицах ShopOrder (сам заказ), ShopOrderProduct (содержимое заказа), ShopOrderEmployer (исполнители и наблюдатели заказа), ShopOrderContact (контакты заказа) и тд.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Бизнес-процессы</strong> (Workflow) и их <strong>статусы</strong> (Status) и <strong>действия</strong> (Action)</td>
        <td>WorkflowService</td>
        <td>ShopCategory, ShopOrderStatus</td>
        <td>
            Каждый проект, заказ и тд идет по определенному бизнес-процессу (БП). Бизнес-процесс - это набор этапов, которые соединены между собой возможными переходами (стрелками). В каждом этапе можно настроить:<br />
            <ol>
                <li>интерфейс как будет выглядеть проект/заказ/задача в этом этапе</li>
                <li>действия Action, которые должны быть выполнены при переходе в этот этап.</li>
                <li>действия Action (cron), которые будут выполняться постоянно, если задача находится в этом этапе.</li>
            </ol>
            <br />

            Что такое действия? Проще объяснить на примере.<br />
            Например, есть бизнес-процесс “Прием заказа”, в нем есть куча этапов и один из них “Новый заказ”. В этом этапе (статусе) можно добавить последовательность таких действий: Отправлять email клиенту, отправлять SMS клиенту, отправлять email менеджеру и т.д. Действий может быть очень много, и модули могут добавлять свои. Подробнее смотрите в документации про Действия (Action).
        </td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Файловая система</strong> и хранилище вложенных файлов</td>
        <td>FileService</td>
        <td>ShopFile</td>
        <td>Любой файл, которые куда-либо будет загружен в OneBox будет зарегистрирован в FileService. Уникальным идентификатором файла является его md5-hash, что позволяет хранить файлы где угодно и как угодно.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>История изменений</strong></td>
        <td>HistoryService</td>
        <td>ShopOrderChange, ShopProductChange, ShopUserChange</td>
        <td>Сервис, который отвечает за сохранение истории изменений какого-либо объекта. На текущий момент мы храним изменение только для Контактов (User), заказов и их содержимого (ShopOrder, ShopOrderProduct), товаров (ShopProduct).</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Коммуникации</strong> (события: звонки, email, skype, ...)</td>
        <td>EventService (будет переименовал в CommunicationService)</td>
        <td>ShopEvent (будет переименован в ShopCommunication)</td>
        <td>Все звонки, письма, переписка между сотрудниками, парсер почты IMAP, парсер звонков - все будет в EventService и основной сущности ShopEvent</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Валюты</strong> и конвертация валют</td>
        <td>CurrencyService</td>
        <td>ShopCurrency</td>
        <td>Список валют, конвертация сумм из одной валюты в любую другую, автообновление курса валют и тд</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Права доступа</strong> ACL</td>
        <td>ACLService</td>
        <td>XUserACL, XUserACLKey</td>
        <td>Список прав доступа, контроль доступа к любым методам и сущностям OneBox</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Система переводов</strong> (языки)</td>
        <td>TranslateService</td>
        <td>-</td>
        <td>Система переводов загружает переводы из lang.php-файла и подставляет их в виде smarty-переменных в каждый отдельно взятый контент.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td>Глобальные <strong>настройки</strong></td>
        <td>SettingService</td>
        <td>XShopSetting</td>
        <td>Глобальные настройки системы settings. По сути это таблица в БД, в которой хранится ключ, его название и значение настройки. Любые части системы могут обратиться к settings, прочитать значение или создать новую настройку.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Роли</strong> сотрудников</td>
        <td>RoleService</td>
        <td>ShopRole</td>
        <td>Роли - это тоже самое что “Должности” (positions). Каждый сотрудник может быть привязан к неограниченному количеству ролей. Например, Вася - это директор, менеджер, уборщица и т.д.</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Ключевые показатели KPI</strong></td>
        <td>KPIService</td>
        <td>ShopKPI, ShopKPIRole, ShopKPIUser</td>
        <td>
        На каждую роль (Role) можно назначить ключевые показали эффективности (KPI). Это значения, которые считаются каждый час и записываются в историю, затем их можно показывать, сравнивать и тд.<br />
        Примеры KPI: количество закрытых задач, количество новых заказов, сумма заказов за определенный период, и тд.<br />
        KPI настраиваются под каждого клиента (проект) индивидуально. Модули могут добавлять свои KPI в систему.<br />
        </td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Модули</strong>, их загрузчик и настройки</td>
        <td>ModuleLoader</td>
        <td>-</td>
        <td>OneBox - модульная система. Даже сам OneBox по умолчанию это несколько модулей, соедененных между собой: contact, order, box, document, finance, storage. Между модулями есть зависимости (requirements), которые решает ModuleLoader.<br />
        ModuleLoader отвечает за подключение новый модулей, контроль их загрузки.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Модули</strong>, их загрузчик и настройки</td>
        <td>ModuleLoader</td>
        <td>-</td>
        <td>OneBox - модульная система. Даже сам OneBox по умолчанию это несколько модулей, соедененных между собой: contact, order, box, document, finance, storage. Между модулями есть зависимости (requirements), которые решает ModuleLoader.<br />
        ModuleLoader отвечает за подключение новый модулей, контроль их загрузки.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Режимы работы и отладки</strong> (технический модуль)</td>
        <td>ModeService</td>
        <td></td>
        <td>Управляет режимами работы OneBox и помогает отлаживать код (отладчик и debugger).</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Наценки</strong> и пересчет цен</td>
        <td>MarginService</td>
        <td>@todo</td>
        <td>На каждую категорию, бренд, продукт или группу продуктов можно сделать свои правила наценок (и их может быть много).<br />
        Например, для категории “Ноутбуки” могут быть такие правила: при входящей цене от 0 до 100 USD - наценка 10%, от 100 до 200 - 20 USD, от 200 и выше - 30 USD.<br />
        Можно настроить расписание, как правильно пересчитывать цены, откуда брать входящую цену: из товара, со склада, самую выгодную.<br />
        Модуль пересчета цен определяет самого выгодного поставщика.</td>
        <td>модуль product-margin</td>
    </tr>

    <tr valign="top">
        <td><strong>Финансы</strong> и управленческий финансовый учет (платежи, баланс, ожидаемые платежи)</td>
        <td>Finance...</td>
        <td></td>
        <td>Отдельный модуль, который отвечает за хранение платежей, подсчет баланса на кошельках (аккаунтах), подсчет баланса на контактах, подсчет баланса на компаниях (юридических лицах), ведение и подсчет ожидаемых платежей.</td>
        <td>модуль finance</td>
    </tr>

    <tr valign="top">
        <td><strong>Документы</strong> и документооборот (счета, акты, любые документы по шаблону)</td>
        <td>DocumentService</td>
        <td>ShopDocument, ShopDocumentTemplate</td>
        <td>Отдельный модуль, который отвечает за формирование и хранение любых документов по заданному шаблону. Шаблоны настраиваются прямо в интерфейсе. Нужно выписать акт, счет-фактуру, договор - все это делает модуль document.</td>
        <td>модуль document</td>
    </tr>

    <tr valign="top">
        <td><strong>Склады</strong>, складской учет, инвентаризационный учет</td>
        <td>Storage...</td>
        <td></td>
        <td>Отдельная большая подсистема, которая обслуживает склады, приходование товаров на склады, перемещения между складами, отгрузки со складов, производство (комплектование и раскомплекторование), историю всех складских операций.</td>
        <td>модуль storage</td>
    </tr>

    <tr valign="top">
        <td><strong>Телефония</strong> (IP-телефония)</td>
        <td>VoIPService</td>
        <td>AsteriskAMI, ShopUserVoIP</td>
        <td>Универсальный VoIPService отвечает за регистрацию входящих звонков, всплывающего окошка при звонке, оригинацию звонков (позвонить кому-то, click-to-call, click2call).</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Отчеты</strong></td>
        <td>ReportService</td>
        <td></td>
        <td>OneBox позволяет строить множество отчетов, и добавлять свои отчеты с систему. За это отвечает ReportService.</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Рабочие графики</strong> сотрудников</td>
        <td>WorkTimeService</td>
        <td></td>
        <td>На каждый контакт (не обязательно именно сотрудник) - можно настроить его рабочий график и правила, по которым он будет продлеваться. Можно узнать будет ли работать сотрудник в такое-то время, можно узнать работает или работал-ли поставщик в такое-то время. Сервис можно интегрировать с системой контроля доступа в офис (электрозамок в офис).</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Система уведомлений notify</strong></td>
        <td>NotifyService</td>
        <td></td>
        <td>В OneBox есть специальный сервис, который отвечает за генерацию уведомлений пользователям. Например, что у вас пропущенный звонок, или что вы просрали какой-то заказ, забыли позвонить, у кого-то день рождение и тд. NotifyService доступен в модуле box и по сути занимается тем, что ставит задачи сотрудникам по определенным правилам, а если актуальной задачи нет - то старые закрывает.</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Центр уведомлений</strong></td>
        <td>NotificationService</td>
        <td></td>
        <td>Центр уведомлений управляет “красным квадратиком” и уведоллениями, которые поступают пользователю. Это что-то похожее на центр уведомлений Facebook или Новости vk. Все изменения в системе, которые вам нужно увидеть будут в центре уведомлений.<br />
        Можно добавлять свои уведомления из модулей или любой части системы.<br />
        Центр уведомлений дополнительно может слать копии всех уведомлений на почту (email) сотрудника.</td>
        <td>модуль box</td>
    </tr>

    <tr valign="top">
        <td><strong>Планировщик задач</strong> (cron, крон)</td>
        <td></td>
        <td></td>
        <td>Подсистема OneBox, которая отвечает за плановый запуск процессов по расписанию. Так называемый UNIX cron.
        Доступны cron minute, cron hour, cron day.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Файл конфигурации</strong> engine.mode.php</td>
        <td></td>
        <td></td>
        <td>Большой конфигурационный файл, в котором есть большое количество технических опций. Не доступен для редактирования смертному юзеру.<br />
        В файле можно подключить/отключить модули, задать режимы работы OneBox, дописать или убрать опции.<br />
        Полный реестр всех возможных опций - это файл example.engine.mode.php.<br />
        В каждом модуле может быть список своих опций и свой example.engine.mode.php</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Система технических событий Events</strong></td>
        <td></td>
        <td></td>
        <td>Это система доступная в Engine и SQLObject, но OneBox ее использует под себя.<br />
        Вы можете дописывать и вешать свои обработчики на каждое событие, которое генерирует система, генерировать свои события.<br />
        Кстати, cron - это тоже событие.</td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td><strong>Работа с базой данных</strong> (коннекторы и ORM)</td>
        <td>SQLObject, ConnectionManager</td>
        <td></td>
        <td>Пакеты packages, которые являются прослойкой для работы вышеописанных сервисов и базы данных. Мы не пишем SQL-запросы напрямую. В большинстве случаев работа происходит так:<br />
        <ul>
            <li>мы работаем с объектым SQLObject (ORM),</li>
            <li>который через ConnectionManager соеденен с СУБД (MySQL, MariaDB, ...),</li>
            <li>и который уже делает обращение напрямую в БД в зависимости от особенностей настройки сервера</li>
        </ul>
        </td>
        <td>всегда</td>
    </tr>

    <tr valign="top">
        <td>Внешнее <strong>REST API</strong> для интеграций с OneBox</td>
        <td></td>
        <td></td>
        <td>OneBox имеет REST API, через коротое с ним могут интегрироваться любые CRM, ERP, интернет-магазины, внешние сервисы, VoIP-телефония и т.д.
        Позволяет получать и управлять товарами, заказами, контактами.</td>
        <td>модуль rest-api</td>
    </tr>

    <tr valign="top">
        <td><strong>Поисковая система на базе Sphinx</strong></td>
        <td>Sphinx_..</td>
        <td></td>
        <td>Опциональный модуль, без которого очень тяжело работать когда у вас более 10000 товаров, заказов, контактов и тд. Модуль заменяет полнотекстовый поиск MySQL/MariaDB на собственный Sphinx-based, который быстрее в 1000 раз, может обрабатывать огромные массивы информации (10 млн товаров не проблема), умеет искать с учетом ошибок, опечаток и переворачивание раскладки (ye ds gjyzkb j xtv z :).</td>
        <td>модуль search-sphinx</td>
    </tr>

</table>

<br />
<br />
