<h1>Инструкция по вливанию данных клиентов в OneBox</h1>

Когда клиент покупает OneBox, то он предоставляет данные в XLS/XLSX/CSV
которые он хочет влить в OneBox перед началом работы.<br />
<strong>Как правило это база клиентов, заказы и оплаты этих клиентов.</strong><br />
<br />

Данная инструкция описывает менеджерам и разработчикам что нужно делать, чтобы влить данные правильно.<br />
<br />

<h2>Необходимо получить от клиента информацию что он хочет влить.</h2>

Клиент может прислать следующее:
<ul>
    <li>базу (таблицу) клиентов</li>
    <li>базу (таблицу) заказов</li>
    <li>базу (таблицу) товаров</li>
    <li>базу (таблицу) платежей</li>
    <li>базу (таблицу) склада</li>
</ul>

Критически важно, чтобы:<br />
<ul>
    <li>Все файлы были в XLS XLSX или CSV. Чтобы вы могли их открыть.<br />
        В редких случаях допускается JSON или XML, если данные присылает программист старой системы, из которой берутся данные.</li>
    <li><strong>В таблице клиентов</strong> чтобы обязательно были поля:<br />
        Фамилия, Имя, отчество, название компании. Достаточно чего-то одного, например, название компании или только фамилия + имя<br />
        Телефон или email. Любой из этих контактов. Без контактных данных влить в OneBox карточку клиента будет проблематично.<br />
        Очень важно чтобы телефон был в полном формате. Для этого обычно можно сделать пару проверок:<br />
        Если телефон начинается на 0 – то дописываем в начало 38.<br />
        Если телефон начинается на 8 – то дописываем в начало 3.<br />
        Если длинна телефона некорректная – то сообщите менеджеру что у нас битые данные, но все равно вливайте битые.<br />
    </li>
    <li><strong>В таблице заказов</strong> нужно чтобы были обязательно:<br />
        дата заказа или группы заказов<br />
        название клиента, которое должно совпадать с названием в базе клиентов.<br />
        сумма заказа<br />
        состав заказа или название товара, который покупают. Название товара + количество товара + цена товара.<br />
        возможно менеджер заказа (ФИО менеджера полностью без сокращений)<br />
        оплачен заказ или не оплачен. Если этого поля нет - заказ будет считаться оплаченным.<br />
        <strong>Таблица платежей должна быть совмещена с таблицей заказов</strong> сразу.<br />
    </li>
    <li><strong>В таблице товаров</strong> нужно:<br />
        название товара<br />
        цена товара (все цены должны быть в одной валюте!)<br />
        себестоимость товара (если это поле известно)<br />
        наличие товара (есть или нет или количество, если это склад клиента)<br />
    </li>
</ul>

<h2>Когда нужно вливать эти данные?</h2>
Сразу после настройки бизнес-процессов заказа.<br />
Иными словами - <strong>сначала настраиваем БП для заказа и потом вливаем данные в правильном порядке</strong>.<br />
<br />

<h2>Технический алгоритм для влияния данных</h2>
Ваша задача влить предоставленные данные в заказы, контакты, продукты и платежи.<br />
<br />

Наиболее правильный способ как это делать:<br />
<ol>
    <li><strong>сначала вливайте базу контактов</strong>.<br />
        Важно - обязательно выставить тип карточки контакта (typesex). У вас это будет или company или man.<br />
        Правильно влитая карточка контакта, это когда у вас влиты поля:<br />
        a.	ФИО и/или название компании в поля company, name, namelast, middlename<br />
        b.	выставлен typesex=company или typesex=man<br />
        c.	выставлена дата cdate контакта (можно now)<br />
        d.	есть хотя-бы один из контактов (например, телефон или емейл)<br />
    </li>
    <li><strong>Затем вливайте базу товаров</strong>.<br />
        Неважно как вы это сделаете и будет ли она разбросана по категориям.<br />
        Главное чтобы были объекты ShopProduct с полями:<br />
        a.	Name<br />
        b.	Price<br />
        c.	Currencyid (если валюта не известна – ставьте сюда системную валюту)<br />
        d.	Pricebase – закупочную цену, если она известна. Если не известна – ставьте 0.<br />
    </li>
    <li><strong>в конце вливаем заказы и платежи сразу</strong>.<br />
        В цикле на каждый заказ создаем ShopOrder с нужными нам данными.<br />
        a.	В процессе у вас будет ФИО клиента или название компании - проверяете есть такой контакт или нет, и затем его создаете. Созданный или найденный контакт привязываете к заказу.<br />
        a1.	Если сразу в исходной таблице заказов у вас будут данные по email или телефоне клиента – то лучше ищите контакт в базе по этим данным. Через метод findUserByContact()<br />
        b.	У вас будет ФИО менеджера - аналогичные действия.<br />
        c.	У вас будет название товара - проверяете по имени есть такой товар или нет, если нет - создаете. Создаете на основе этого товара ShopOrderProduct.<br />
        d.	Платежи:<br />
        d1.	Если у вас есть данные о платежах заказа - проводите платеж (предварительно руками создайте один аккаунт “Безнал касса”).<br />
        d2.	Если данных о платежах нет - считайте что заказ оплачен на 100% и проводите 100%й платеж.<br />
        e.	Если необходимо провести заказ на склад (оприходовать) - то это делайте так: в действиях по этапу заказа выставляйте руками “Оприходовать на склад” и меняйте статус заказа через updateOrderStatus.<br />
        f.	Изменяйте статус заказа (закрывайте заказ). Это можно сделать через методы closeIssue или updateOrderStatus (предпочтительнее).<br />
    </li>
</ol>

<h2>Технические нюансы</h2>
<ol>
    <li>если вам дали базу в формате XLS или XLSX - то лучше вручную переведите ее в CSV или XLSX и вливайте. Это делается потому, что excel может показывать данные в ячейке как 10.00, а на самом деле через чтение пакет XLS будет вам выдавать 1000.</li>
    <li>В приложенном архиве есть tool-скрипт lactusan-import-1.php, который показывает простой пример вливания данных.</li>
</ol>

<h2>Дополнительные замечания</h2>
<ul>
    <li>Когда вам дают эти базы - ваша задача понять как эти данные максимально просто и красиво положить в бокс.
    <li>в данных могут быть не стыковки. Например, в базе контактов компания называется WebProduction, а в базе заказов будет ВЕБПРОДАКШН. Ваша задача предупредить об этом менеджера (письменно) и влить данные: скрипт который валиает заказы создаст второй “пустой контакт” ВЕБПРОДАКШН.</li>
    <li>Иногда нужно провести входящие и исходящие заказы и на их основе создать склад. Это достаточно простая операция, главное правильно настроить действия в этапах бизнес-процессов - что в каком случае приходовать или списывать.</li>
</ul>

<h2>Пример</h2>
Ниже приведен пример tool-скрипта, который вливает заказы, содержимое закащов и платежи.<br />
По дороге скрипт создает контакты, если их нет.<br />

<code><pre>
require(dirname(__FILE__).'/../packages/Engine/include.2.6.php');

Engine::Get()->enableErrorReporting();

$a = file(dirname(__FILE__).'/l1.txt');

foreach ($a as $x) {
    $x = explode(';', $x);
    print_r($x);

    $productName = trim($x[0]);
    $clientName = trim($x[3]);
    $cdate = trim($x[4]);
    $amount = trim($x[5]);
    $sum = trim($x[6]);
    $managerName = trim($x[7]);

    $amount = substr($amount, 0, strlen($amount) - 1);
    $amount = StringUtils_FormatterPrice::format($amount);
    $sum = StringUtils_FormatterPrice::format($sum);

    print $amount."\n";
    print $sum."\n";

    $cdate = substr($cdate, 6, 4).'-'.substr($cdate, 3, 2).'-'.substr($cdate, 0, 2);
    $cdate = DateTime_Formatter::DateTimeISO9075($cdate);

    $tmp = explode(' ', $managerName);
    $managerNameLast = trim(@$tmp[0]);

    $price = $sum / $amount;

    // проверяем чтобы был такой менеджер
    if ($managerNameLast) {
        $manager = new User();
        $manager->setEmployer(1);
        $manager->setNamelast($managerNameLast);
        if (!$manager) {
            $manager->setDistribution(1);
            $manager->setCdate($cdate);
            $manager->insert();
        }

        $managerID = $manager->getId();
    } else {
        $managerID = 0;
    }

    // проверяем чтобы такой клиенты был
    $client = new User();
    $client->setCompany($clientName);
    if (!$client->select()) {
        $client->setDistribution(1);
        $client->setCdate($cdate);
        $client->setManagerid($managerID);
        $client->insert();
    } else {
        $client->setManagerid($managerID);
        $client->update();
    }

    // создаем товар если его еще нет
    $product = new ShopProduct();
    $product->setName($productName);
    if (!$product->select()) {
        $product->setPrice($price);
        $product->setCurrencyid(1);
        $product->insert();
    }

    // создаем заказ если его еще нет
    $order = new ShopOrder();
    $order->setCategoryid(1);
    $order->setCdate($cdate);
    $order->setManagerid($managerID);
    $order->setUserid($client->getId());
    if (!$order->select()) {
        $order->setStatusid(23);
        $order->setDateclosed($cdate);
        $order->insert();

        Shop::Get()->getShopService()->addOrderProduct(
        $order,
        $product->getId(),
        $amount,
        $price
        );

        Shop::Get()->getShopService()->recalculateOrderSums($order);
    }

    $order->setType('order');
    $order->update();

    // проводим платеж
    $payment = new FinancePayment();
    $payment->setCdate($cdate);
    $payment->setPdate($cdate);
    $payment->setClientid($client->getId());
    if (!$payment->select()) {
        $payment->setOrderid($order->getId());
        $payment->setCurrencyid(1);
        $payment->setCurrencyrate(1);
        $payment->setUserid($managerID);
        $payment->setAmount($sum);
        $payment->setAmountbase($sum);
        $payment->setAccountid(1);
        $payment->insert();
    }
}

print "\n\ndone.\n\n";
</pre></code>